# PRD: GC Storage - クラウドストレージシステム

## 概要

GC Storageは、フルスクラッチで構築するクラウドストレージシステムです。個人利用からチーム・グループでの共同作業まで対応し、ファイルの安全な保存・共有・管理を実現します。

## 目的

- ユーザーが安全にファイルを保存・管理できる環境を提供する
- グループ単位での柔軟なファイル共有と権限管理を実現する
- 将来的なスケーラビリティを考慮した拡張性の高いアーキテクチャを構築する

---

## 1. 機能要件 (Functional Requirements)

### 1.1 基本機能

#### 1.1.1 ファイルアップロード/ダウンロード

| 項目 | 内容 |
|------|------|
| 概要 | ユーザーがファイルをストレージにアップロード・ダウンロードできる |
| 対応 | 大容量ファイル（マルチパートアップロード対応）、複数ファイルの同時処理 |
| 制約 | アップロード可能な最大ファイルサイズは設定で制御可能とする |

#### 1.1.2 フォルダ管理

| 操作 | 説明 |
|------|------|
| 作成 | 任意の階層にディレクトリを作成 |
| 移動 | フォルダおよびその中身を別の場所へ移動 |
| 名前変更 | フォルダ名の変更 |
| 削除 | 論理削除（ゴミ箱）と物理削除の両方をサポート |

#### 1.1.3 ファイルプレビュー

ブラウザ上でファイルの内容を表示する機能。

| ファイル種別 | 対応 |
|-------------|------|
| 画像 | JPEG, PNG, GIF, WebP, SVG |
| ドキュメント | PDF, テキストファイル |
| その他 | 対応形式は段階的に拡張 |

#### 1.1.4 全文検索・フィルタリング

| 検索条件 | 説明 |
|---------|------|
| ファイル名 | 部分一致検索 |
| 拡張子 | ファイルタイプによる絞り込み |
| 更新日時 | 日付範囲による絞り込み |
| メタデータ | サイズ、MIMEタイプなど |

---

### 1.2 オブジェクト管理

#### 1.2.1 一意なID管理

- ファイルの実体をUUID等の一意識別子で管理
- ファイル名の重複を許容しつつ、内部的には一意に識別

#### 1.2.2 バージョン管理

- 同一ファイル名でアップロードされた場合、履歴として保持
- 過去バージョンの参照・復元が可能

#### 1.2.3 メタデータ保持

自動取得するメタデータ:

| 項目 | 説明 |
|------|------|
| サイズ | ファイルサイズ（バイト） |
| MIMEタイプ | ファイルの種別を示すContent-Type |
| ハッシュ値 | MD5およびSHA256による整合性チェック用 |
| 作成日時 | アップロード日時 |
| 更新日時 | 最終更新日時 |

---

### 1.3 ユーザー・共有機能

#### 1.3.1 認証・認可

| 機能 | 説明 |
|------|------|
| サインアップ | メールアドレス・パスワードによる新規登録 |
| ログイン | 認証情報によるセッション開始 |
| アクセス制限 | 自分以外のファイルへの不正アクセスを防止 |

#### 1.3.2 共有リンク生成

- 特定のファイルに対して外部公開用のURLを発行
- 期限付きURL（有効期限を設定可能）
- オプションでパスワード保護

---

### 1.4 グループ管理機能

#### 1.4.1 グループの作成・管理

- ユーザーがグループを作成できる（例：「開発チーム」「家族」）
- 他のユーザーをグループに招待・削除できる
- グループの名前・説明の編集

#### 1.4.2 ロール管理

| ロール | 権限 |
|--------|------|
| オーナー | グループの全権限、グループの削除、オーナー譲渡 |
| 管理者 | メンバーの招待・削除、共有フォルダの管理 |
| 一般メンバー | 共有されたファイル・フォルダへのアクセス |

---

### 1.5 共同フォルダ機能（共有ロジック）

#### 1.5.1 フォルダの所有形態

| 形態 | 説明 |
|------|------|
| 個人所有 | 特定ユーザーが所有するプライベートフォルダ |
| グループ所有 | グループに紐付けられた共同フォルダ |

#### 1.5.2 アクセス権限（ACL）

| 権限レベル | 可能な操作 |
|-----------|-----------|
| 閲覧のみ | ファイルの表示、ダウンロード |
| 編集可能 | ファイルのアップロード、上書き、削除、フォルダ作成 |

#### 1.5.3 権限の継承ルール

- 親フォルダに設定された共有権限は、子フォルダ・ファイルに自動継承
- 子要素で個別に権限を上書き可能（オプション）
- 継承元の変更は配下すべてに伝播

---

## 2. 非機能要件 (Non-Functional Requirements)

### 2.1 信頼性・データ保護

#### 2.1.1 データ整合性

- アップロード中の中断時、不完全なデータが残らない設計
- トランザクション管理による原子性の保証
- チェックサム照合による転送エラーの検出

#### 2.1.2 永続性

- サーバー再起動後もデータが消失しない
- オブジェクトストレージ（MinIO等）のボリュームマウントによる永続化
- メタデータDBの永続化

---

### 2.2 パフォーマンス

#### 2.2.1 低遅延レスポンス

| 指標 | 目標 |
|------|------|
| ファイル一覧表示 | 適切なDBインデックス設計による高速化 |
| 検索クエリ | インデックス活用による効率的な検索 |

#### 2.2.2 スケーラビリティ

- ストレージ容量の増設に対応（HDD追加等）
- クラウドストレージ（AWS S3等）への移行パス確保
- マイクロサービス化による水平スケーリング対応

---

### 2.3 セキュリティ

#### 2.3.1 アクセス制御

- 署名付きURL（Presigned URL）によるオブジェクトアクセス
- オブジェクトストレージの生URLを直接露出しない
- トークンベースの認証（JWT等）

#### 2.3.2 通信の暗号化

- HTTPS（TLS 1.2以上）による全通信の暗号化
- 保存データの暗号化（オプション）

---

### 2.4 運用・保守

#### 2.4.1 ログ

| ログ種別 | 内容 |
|---------|------|
| エラーログ | アップロード失敗、認証エラー等の記録 |
| アクセスログ | ユーザー操作の監査証跡 |
| システムログ | サーバー・インフラの稼働状況 |

#### 2.4.2 バックアップ

- オブジェクトデータとメタデータ（DB）の整合性を保ったバックアップ
- ポイントインタイムリカバリ対応
- バックアップのリストアテスト手順

---

## 3. 技術的考慮事項

### 3.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                        Client                               │
│                  (Web Browser / API)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      API Gateway                            │
│                  (認証・ルーティング)                         │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────────┐
│     Application         │     │     Object Storage          │
│       Server            │     │       (MinIO/S3)            │
│  (ビジネスロジック)       │────▶│    (ファイル実体)            │
└─────────────────────────┘     └─────────────────────────────┘
              │
              ▼
┌─────────────────────────┐
│       Database          │
│   (メタデータ管理)        │
│   PostgreSQL/MySQL      │
└─────────────────────────┘
```

### 3.2 主要コンポーネント

| コンポーネント | 役割 | 技術候補 |
|--------------|------|---------|
| API Server | ビジネスロジック、認証・認可 | Node.js/Go/Rust |
| Object Storage | ファイル実体の保存 | MinIO (S3互換) |
| Database | メタデータ、ユーザー情報 | PostgreSQL |
| Cache | セッション、一時データ | Redis |

---

## 4. 用語集

| 用語 | 定義 |
|------|------|
| オブジェクト | ストレージに保存されるファイルの実体 |
| メタデータ | ファイルに関する付随情報（サイズ、日時、権限等） |
| Presigned URL | 一時的にアクセスを許可する署名付きURL |
| ACL | Access Control List（アクセス制御リスト） |
| 論理削除 | データを削除フラグで非表示にする（復元可能） |
| 物理削除 | データを完全に削除する（復元不可） |

---

## 5. 今後の拡張候補

以下は初期リリース後に検討する機能:

- [ ] ファイル内容の全文検索（Elasticsearch連携）
- [ ] リアルタイム同期（WebSocket）
- [ ] デスクトップクライアント
- [ ] モバイルアプリ
- [ ] Webhook/API連携
- [ ] ストレージ使用量のクォータ管理
- [ ] 2要素認証（2FA）

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2026-01-17 | 1.0.0 | 初版作成 |
