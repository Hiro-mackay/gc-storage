# フロントエンドルーティング仕様書

## メタ情報

| 項目 | 値 |
|------|-----|
| ステータス | Ready |
| 優先度 | High |
| 関連仕様 | fe-foundation, fe-auth-pages, fe-file-browser |

---

## 1. 概要

本ドキュメントでは、フロントエンドのルーティング要件を定義します。TanStack Routerを使用し、認証状態に応じたアクセス制御を実装します。

---

## 2. ルート一覧

### 2.1 公開ルート（認証不要）

| パス | 説明 | 認証済み時の動作 |
|------|------|-----------------|
| `/login` | ログインページ | `/files` へリダイレクト |
| `/register` | 新規登録ページ | `/files` へリダイレクト |
| `/forgot-password` | パスワードリセット要求 | `/files` へリダイレクト |
| `/reset-password` | パスワードリセット | そのまま表示 |
| `/verify-email` | メール確認 | そのまま表示 |
| `/oauth/callback/:provider` | OAuthコールバック | 処理後 `/files` へリダイレクト |

### 2.2 認証必須ルート

| パス | 説明 | 未認証時の動作 |
|------|------|---------------|
| `/` | ホーム | `/files` へリダイレクト |
| `/files` | マイファイル（ルートフォルダ） | `/login` へリダイレクト |
| `/files/:folderId` | フォルダ詳細 | `/login` へリダイレクト |
| `/trash` | ゴミ箱 | `/login` へリダイレクト |
| `/starred` | スター付き | `/login` へリダイレクト |
| `/recent` | 最近のファイル | `/login` へリダイレクト |
| `/shared` | 共有されたファイル | `/login` へリダイレクト |
| `/groups` | グループ一覧 | `/login` へリダイレクト |
| `/groups/:groupId` | グループ詳細 | `/login` へリダイレクト |
| `/settings` | 設定 | `/login` へリダイレクト |

---

## 3. 認証ガード

### 3.1 リダイレクトルール

**未認証ユーザーが認証必須ページにアクセス**:
1. 元のURLを保存
2. `/login` にリダイレクト
3. ログイン成功後、元のURLにリダイレクト

**認証済みユーザーがログインページにアクセス**:
1. `/files` にリダイレクト

### 3.2 認証チェックタイミング

| タイミング | 動作 |
|-----------|------|
| アプリ起動時 | GET /api/v1/me で認証状態を確認 |
| ルート遷移時 | ストアの認証状態をチェック |
| APIエラー（401） | 認証状態をクリア、ログインへリダイレクト |

### 3.3 初期化中の表示

認証状態が `initializing` の間:
- ローディング画面を表示
- ルートコンポーネントはレンダリングしない

---

## 4. レイアウト構造

### 4.1 レイアウト階層

```
__root (ルートレイアウト)
├── _auth (認証不要レイアウト)
│   ├── login
│   ├── register
│   ├── forgot-password
│   ├── reset-password
│   ├── verify-email
│   └── oauth/callback/:provider
└── _authenticated (認証必須レイアウト)
    ├── files
    ├── files/:folderId
    ├── trash
    ├── starred
    ├── recent
    ├── shared
    ├── groups
    ├── groups/:groupId
    └── settings
```

### 4.2 各レイアウトの責務

**__root**:
- グローバルプロバイダー（QueryClient, TooltipProvider）
- トースト通知（Sonner）
- エラーバウンダリ

**_auth**:
- 中央揃えレイアウト
- ロゴ表示
- 認証済みの場合リダイレクト

**_authenticated**:
- ヘッダー + サイドバー + メインコンテンツ
- 未認証の場合リダイレクト
- ユーザー情報の利用

---

## 5. データプリフェッチ

### 5.1 ルートローダー

| ルート | プリフェッチするデータ |
|--------|---------------------|
| `/files` | ルートフォルダ内容 |
| `/files/:folderId` | フォルダ内容 + パンくずリスト |
| `/trash` | ゴミ箱一覧 |

### 5.2 プリフェッチの動作

1. ルート遷移前にローダーが実行される
2. TanStack Queryのキャッシュにデータを格納
3. コンポーネントはキャッシュからデータを取得
4. キャッシュがない場合のみAPIを呼び出し

---

## 6. URL状態管理

### 6.1 クエリパラメータ

| ルート | パラメータ | 用途 |
|--------|----------|------|
| `/files`, `/files/:folderId` | `view` | 表示モード（grid/list） |
| `/files`, `/files/:folderId` | `sort` | ソート項目 |
| `/files`, `/files/:folderId` | `order` | ソート順序（asc/desc） |
| `/login` | `redirect` | ログイン後のリダイレクト先 |
| `/reset-password` | `token` | リセットトークン |
| `/verify-email` | `token` | 確認トークン |
| `/oauth/callback/:provider` | `code`, `state` | OAuth認証情報 |

### 6.2 URLと状態の同期

- 表示設定（view, sort, order）はURLとストアの両方で管理
- URLの値が優先される
- URLパラメータ変更時にストアも更新
- ストア変更時にURLも更新

---

## 7. ナビゲーション動作

### 7.1 フォルダナビゲーション

| 操作 | 動作 |
|------|------|
| フォルダダブルクリック | `/files/:folderId` へ遷移 |
| パンくずクリック | 該当フォルダへ遷移 |
| 「マイファイル」クリック | `/files` へ遷移 |
| ブラウザ戻る/進む | 通常のブラウザ履歴動作 |

### 7.2 サイドバーナビゲーション

| 項目 | リンク先 | アクティブ判定 |
|------|---------|--------------|
| マイファイル | `/files` | `/files` または `/files/*` |
| スター付き | `/starred` | `/starred` |
| 最近 | `/recent` | `/recent` |
| 共有されたファイル | `/shared` | `/shared` |
| グループ | `/groups` | `/groups` または `/groups/*` |
| ゴミ箱 | `/trash` | `/trash` |

---

## 8. エラーハンドリング

### 8.1 404エラー

| 状況 | 表示 |
|------|------|
| 存在しないルート | 404ページ |
| 存在しないフォルダ | 「フォルダが見つかりません」エラー |
| 存在しないファイル | 「ファイルが見つかりません」エラー |

### 8.2 権限エラー

| 状況 | 表示 |
|------|------|
| アクセス権限なし | 「アクセス権限がありません」エラー |

### 8.3 エラーバウンダリ

- 予期しないエラーをキャッチ
- エラーページを表示
- 「ホームに戻る」「再読み込み」ボタンを提供

---

## 9. 受け入れ基準

### 9.1 認証ガード

- [ ] 未認証状態で `/files` にアクセスすると `/login` にリダイレクトされる
- [ ] ログイン後、元々アクセスしようとしていたページに遷移する
- [ ] 認証済み状態で `/login` にアクセスすると `/files` にリダイレクトされる
- [ ] 401エラー時にログインページにリダイレクトされる

### 9.2 ナビゲーション

- [ ] ブラウザの戻る/進むボタンが正常に動作する
- [ ] URLを直接入力してアクセスした場合、正しいページが表示される
- [ ] フォルダ間の遷移が正常に動作する
- [ ] サイドバーのナビゲーションが正常に動作する

### 9.3 URL状態

- [ ] 表示設定がURLに反映される
- [ ] URLからページをリロードしても設定が維持される
- [ ] 設定変更時にURLが更新される

---

## 関連ドキュメント

- [fe-foundation.md](./fe-foundation.md) - フロントエンド基盤仕様
- [fe-auth-pages.md](./fe-auth-pages.md) - 認証画面仕様
- [fe-file-browser.md](./fe-file-browser.md) - ファイルブラウザ仕様
