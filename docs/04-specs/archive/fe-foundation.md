# フロントエンド基盤仕様書

## メタ情報

| 項目 | 値 |
|------|-----|
| ステータス | Ready |
| 優先度 | High |
| 関連ドメイン | user, session |
| 依存する仕様 | auth-identity, infra-api, fe-openapi-typegen |

---

## 1. 概要

本ドキュメントでは、GC Storageフロントエンドの基盤要件（API通信、認証状態管理、ルーティング、レイアウト）を定義します。

**関連アーキテクチャ:**
- [FRONTEND.md](../02-architecture/FRONTEND.md) - フロントエンド設計方針
- [API.md](../02-architecture/API.md) - API設計
- [auth-identity.md](./auth-identity.md) - 認証バックエンド仕様

---

## 2. API通信基盤

### 2.1 ユーザーストーリー

**As a** フロントエンド開発者
**I want to** 統一されたAPI通信基盤を使用する
**So that** バックエンドAPIとの通信を一貫した方法で行える

### 2.2 技術選定

API通信基盤は `openapi-fetch` + `openapi-typescript` を使用します。

| ライブラリ | 用途 |
|-----------|------|
| openapi-fetch | OpenAPIスキーマから型推論するfetch wrapper |
| openapi-typescript | OpenAPIスキーマからTypeScript型定義を自動生成 |

型生成パイプラインの詳細は [fe-openapi-typegen.md](./fe-openapi-typegen.md) を参照。

### 2.3 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| API-01 | APIリクエストにcredentials: 'include'を設定し、Cookieを自動送信する | High |
| API-02 | APIエラーレスポンスを統一された形式でハンドリングする | High |
| API-03 | 401エラー時にログアウト状態に遷移する | High |
| API-04 | ネットワークエラーを適切にハンドリングする | Medium |
| API-05 | リクエストタイムアウトを設定する（30秒） | Medium |
| API-06 | OpenAPIスキーマから生成された型定義でE2Eの型安全性を確保する | High |

### 2.4 エラーハンドリング要件

| HTTPステータス | 動作 |
|---------------|------|
| 400 Bad Request | バリデーションエラーとして処理 |
| 401 Unauthorized | storeをクリアし、ログインページへリダイレクト |
| 403 Forbidden | 権限エラーとして処理 |
| 404 Not Found | リソース未発見エラーとして処理 |
| 500+ Server Error | サーバーエラーとして処理、リトライ可能 |
| Network Error | ネットワークエラーとして処理 |

### 2.5 受け入れ基準

- [ ] APIリクエストにCookieが自動送信される（credentials: 'include'）
- [ ] APIエラーレスポンスからエラーコード・メッセージを取得できる
- [ ] 401エラー時にログイン画面にリダイレクトされる
- [ ] ネットワークエラー時に適切なエラーメッセージが表示される

---

## 3. 認証状態管理

### 3.1 ユーザーストーリー

**As a** ユーザー
**I want to** 一度ログインしたらブラウザを閉じても認証状態が維持される
**So that** 毎回ログインし直す必要がない

### 3.2 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| AUTH-01 | 認証情報（トークン/セッションID）はCookieで管理し、フロントエンドでは永続化しない | High |
| AUTH-02 | アプリ起動時にAPIを呼び出して認証状態を確認する | High |
| AUTH-03 | UI表示用にユーザー情報を一時的にstoreで保持する | High |
| AUTH-04 | ログアウト時にstoreをクリアし、ログアウトAPIを呼び出す | High |
| AUTH-05 | OAuth認証コールバックを処理する | High |
| AUTH-06 | 認証状態の変更をアプリ全体で即時反映する | Medium |

### 3.3 認証状態

| 状態 | 説明 |
|------|------|
| 初期化中 | アプリ起動時、認証状態を確認中（API呼び出し中） |
| 未認証 | ログインしていない状態 |
| 認証済み | ログイン済みの状態 |

### 3.4 認証情報の管理方針

| データ | 管理方法 | 説明 |
|--------|----------|------|
| Session ID | HttpOnly Cookie | バックエンドが設定、フロントエンドからはアクセス不可 |
| ユーザー情報（ID, name, email） | Store（一時的） | UI表示用、ページリロード時はAPIで再取得 |
| 認証状態フラグ | Store（一時的） | UI制御用、永続化しない |

**Cookieが認証の唯一の真の情報源（Single Source of Truth）となる。**

### 3.5 認証確認フロー

1. アプリ起動時、認証状態を「初期化中」に設定
2. `/api/v1/me` APIを呼び出し（Cookieは自動送信される）
3. 成功時：ユーザー情報をstoreに保存、認証状態を「認証済み」に設定
4. 401エラー時：認証状態を「未認証」に設定
5. 初期化完了

### 3.6 セッション自動延長

- 各APIリクエスト時にサーバーがセッションの有効期限を自動延長（スライディングウィンドウ）
- フロントエンドはセッション管理を意識する必要がない
- 7日間アクセスがない場合にセッションが期限切れ

### 3.7 受け入れ基準

- [ ] ログイン後、ブラウザを閉じて再度開いても認証状態が維持される（HttpOnly Cookieによる）
- [ ] アプリ起動時に認証状態の確認が完了するまでローディングが表示される
- [ ] ログアウト後、storeのユーザー情報がクリアされ、Cookieが削除される
- [ ] ページリロード時、APIからユーザー情報を再取得する
- [ ] LocalStorageやSessionStorageに認証情報を保存しない
- [ ] フロントエンドからSession IDにアクセスできない（HttpOnly Cookie）

---

## 4. ルーティング

### 4.1 ユーザーストーリー

**As a** ユーザー
**I want to** URLに直接アクセスしても適切なページが表示される
**So that** ブックマークやリンク共有ができる

### 4.2 ルート定義

| パス | 認証 | 説明 |
|------|------|------|
| `/` | - | ホーム（認証状態に応じてリダイレクト） |
| `/login` | 不要 | ログインページ |
| `/register` | 不要 | 新規登録ページ |
| `/forgot-password` | 不要 | パスワードリセット要求 |
| `/reset-password` | 不要 | パスワードリセット |
| `/verify-email` | 不要 | メール確認 |
| `/oauth/callback/:provider` | 不要 | OAuthコールバック |
| `/files` | 必須 | マイファイル（ルート） |
| `/files/:folderId` | 必須 | フォルダ詳細 |
| `/starred` | 必須 | スター付きファイル |
| `/recent` | 必須 | 最近のファイル |
| `/trash` | 必須 | ゴミ箱 |
| `/shared` | 必須 | 共有されたファイル |
| `/groups` | 必須 | グループ一覧 |
| `/groups/:groupId` | 必須 | グループ詳細 |
| `/settings` | 必須 | 設定 |

### 4.3 認証ガード要件

| ID | 要件 | 優先度 |
|----|------|--------|
| ROUTE-01 | 認証必須ページに未認証でアクセスした場合、ログインページへリダイレクト | High |
| ROUTE-02 | ログイン後、元のリクエストURLにリダイレクト | High |
| ROUTE-03 | 認証済みユーザーがログインページにアクセスした場合、ファイルページへリダイレクト | Medium |
| ROUTE-04 | 存在しないルートは404ページを表示 | Medium |

### 4.4 受け入れ基準

- [ ] 未認証状態で `/files` にアクセスすると `/login` にリダイレクトされる
- [ ] ログイン後、元々アクセスしようとしていたページに遷移する
- [ ] 認証済み状態で `/login` にアクセスすると `/files` にリダイレクトされる
- [ ] ブラウザの戻る/進むボタンが正常に動作する
- [ ] URLを直接入力してアクセスした場合、正しいページが表示される

---

## 5. レイアウト

### 5.1 ユーザーストーリー

**As a** ユーザー
**I want to** どのページでも一貫したナビゲーションを使用できる
**So that** アプリ内を迷わず移動できる

### 5.2 レイアウト構成

#### 5.2.1 認証済みレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ ヘッダー                                                     │
│ [メニュー] ロゴ           [検索]        [通知] [ユーザー]     │
├──────────┬──────────────────────────────────────────────────┤
│          │                                                  │
│ サイド   │                                                  │
│ バー     │                 メインコンテンツ                   │
│          │                                                  │
│          │                                                  │
└──────────┴──────────────────────────────────────────────────┘
```

#### 5.2.2 公開レイアウト（認証ページ用）

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                         ロゴ                                │
│                                                             │
│                  ┌─────────────────┐                        │
│                  │                 │                        │
│                  │   認証フォーム   │                        │
│                  │                 │                        │
│                  └─────────────────┘                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 ヘッダー要件

| ID | 要件 | 優先度 |
|----|------|--------|
| HDR-01 | サイドバーの開閉ボタンを表示する | High |
| HDR-02 | ロゴをクリックするとホームに遷移する | High |
| HDR-03 | 検索ボタンを表示する（将来の検索機能用） | Medium |
| HDR-04 | ユーザーメニュー（プロフィール、設定、ログアウト）を表示する | High |
| HDR-05 | ユーザーのアバター画像またはイニシャルを表示する | Medium |

### 5.4 サイドバー要件

| ID | 要件 | 優先度 |
|----|------|--------|
| SB-01 | 主要なナビゲーションリンクを表示する | High |
| SB-02 | 現在のページに対応するリンクをハイライトする | High |
| SB-03 | 開閉状態を切り替えられる | High |
| SB-04 | 閉じた状態でもアイコンでナビゲーション可能 | Medium |
| SB-05 | 開閉状態をブラウザに記憶する | Low |

### 5.5 ナビゲーション項目

| 項目 | アイコン | リンク先 |
|------|---------|---------|
| マイファイル | フォルダ | `/files` |
| スター付き | 星 | `/starred` |
| 最近 | 時計 | `/recent` |
| 共有されたファイル | 共有 | `/shared` |
| グループ | ユーザーグループ | `/groups` |
| ゴミ箱 | ゴミ箱 | `/trash` |

### 5.6 受け入れ基準

- [ ] ヘッダーが全ページで表示される
- [ ] サイドバーの開閉状態が切り替わる
- [ ] 現在のページに対応するナビゲーションがハイライトされる
- [ ] ユーザーメニューからログアウトできる
- [ ] レスポンシブ対応：モバイルではサイドバーがオーバーレイ表示される

---

## 6. UI設定の永続化

### 6.1 ユーザーストーリー

**As a** ユーザー
**I want to** 表示設定（グリッド/リスト、ソート順など）が保存される
**So that** 毎回設定し直す必要がない

### 6.2 永続化する設定

| 設定 | デフォルト値 | 説明 |
|------|-------------|------|
| viewMode | `list` | ファイル表示モード（list/grid） |
| sortBy | `name` | ソート項目 |
| sortOrder | `asc` | ソート順序 |
| sidebarOpen | `true` | サイドバー開閉状態 |
| theme | `system` | テーマ（light/dark/system） |

### 6.3 受け入れ基準

- [ ] 表示モードを変更した後、ブラウザを再起動しても設定が維持される
- [ ] ソート設定がページ遷移後も維持される
- [ ] サイドバーの開閉状態がページ遷移後も維持される

---

## 7. エラー表示

### 7.1 ユーザーストーリー

**As a** ユーザー
**I want to** エラーが発生した場合に分かりやすいメッセージを見る
**So that** 何が起きたか理解し、次のアクションを取れる

### 7.2 エラー表示要件

| ID | 要件 | 優先度 |
|----|------|--------|
| ERR-01 | 予期しないエラーをキャッチしてフォールバックUIを表示する | High |
| ERR-02 | エラー発生時に「再試行」オプションを提供する | High |
| ERR-03 | APIエラーをユーザーフレンドリーなメッセージに変換する | High |
| ERR-04 | 開発環境ではエラー詳細を表示する | Low |

### 7.3 エラーメッセージ対応表

| エラーコード | 表示メッセージ |
|-------------|--------------|
| NETWORK_ERROR | インターネット接続を確認してください |
| UNAUTHORIZED | ログインが必要です |
| FORBIDDEN | この操作を行う権限がありません |
| NOT_FOUND | リソースが見つかりませんでした |
| VALIDATION_ERROR | 入力内容を確認してください |
| SERVER_ERROR | サーバーでエラーが発生しました。しばらく待ってから再試行してください |

### 7.4 受け入れ基準

- [ ] 予期しないエラーが発生してもアプリがクラッシュしない
- [ ] エラー発生時に「再試行」ボタンが表示される
- [ ] APIエラーが日本語メッセージで表示される

---

## 8. ローディング状態

### 8.1 ユーザーストーリー

**As a** ユーザー
**I want to** 処理中であることが視覚的に分かる
**So that** アプリが応答しているか判断できる

### 8.2 ローディング表示要件

| ID | 要件 | 優先度 |
|----|------|--------|
| LOAD-01 | ページ読み込み中にスピナーを表示する | High |
| LOAD-02 | ボタンクリック後、処理中は操作を無効化する | High |
| LOAD-03 | 長時間の処理には進捗表示を提供する | Medium |
| LOAD-04 | スケルトンスクリーンでコンテンツプレースホルダを表示する | Medium |

### 8.3 受け入れ基準

- [ ] ページ遷移時にローディングインジケータが表示される
- [ ] フォーム送信中はボタンが無効化され、スピナーが表示される
- [ ] データ取得中はスケルトンまたはスピナーが表示される

---

## 9. レスポンシブ対応

### 9.1 ブレークポイント

| 名前 | 幅 | 対象デバイス |
|------|-----|-------------|
| sm | 640px | モバイル横向き |
| md | 768px | タブレット |
| lg | 1024px | デスクトップ小 |
| xl | 1280px | デスクトップ |

### 9.2 レスポンシブ要件

| ID | 要件 | 優先度 |
|----|------|--------|
| RES-01 | モバイルでサイドバーがハンバーガーメニューに変わる | High |
| RES-02 | モバイルでファイル一覧がシングルカラムになる | High |
| RES-03 | タッチデバイスでタップ操作が適切に動作する | Medium |

### 9.3 受け入れ基準

- [ ] 320px幅でもコンテンツが切れずに表示される
- [ ] タブレットサイズでサイドバーが適切に表示される
- [ ] デスクトップサイズでフルレイアウトが表示される

---

## 10. 非機能要件

### 10.1 パフォーマンス

| 項目 | 目標値 |
|------|--------|
| 初回ロード（LCP） | 2.5秒以内 |
| インタラクション応答（FID） | 100ms以内 |
| レイアウトシフト（CLS） | 0.1以下 |

### 10.2 アクセシビリティ

| ID | 要件 | 優先度 |
|----|------|--------|
| A11Y-01 | キーボードのみでナビゲーション可能 | High |
| A11Y-02 | フォーカス状態が視覚的に分かる | High |
| A11Y-03 | スクリーンリーダーで操作可能 | Medium |
| A11Y-04 | 色のみに依存しない情報伝達 | Medium |

---

## 関連ドキュメント

- [FRONTEND.md](../02-architecture/FRONTEND.md) - フロントエンド設計
- [API.md](../02-architecture/API.md) - API設計
- [auth-identity.md](./auth-identity.md) - 認証仕様
- [fe-auth-pages.md](./fe-auth-pages.md) - 認証画面仕様
- [fe-file-browser.md](./fe-file-browser.md) - ファイルブラウザ仕様
