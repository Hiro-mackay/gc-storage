# 認証画面仕様書

## メタ情報

| 項目 | 値 |
|------|-----|
| ステータス | Ready |
| 優先度 | High |
| 関連ドメイン | user, session, oauth_account |
| 依存する仕様 | fe-foundation, auth-identity |

---

## 1. 概要

本ドキュメントでは、GC Storageの認証関連画面（ログイン、新規登録、OAuthコールバック、パスワードリセット）の要件を定義します。

**関連仕様:**
- [fe-foundation.md](./fe-foundation.md) - フロントエンド基盤
- [auth-identity.md](./auth-identity.md) - 認証バックエンド仕様

---

## 2. ログイン画面

### 2.1 ユーザーストーリー

**As a** 登録済みユーザー
**I want to** メールアドレスとパスワードでログインする
**So that** 自分のファイルにアクセスできる

### 2.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│                      GC Storage                         │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │                   Log in                          │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │ Email                                       │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │ Password                                    │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │                                                   │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │              Log in                         │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │  Forgot password?                                 │  │
│  │                                                   │  │
│  │  ────────────── or continue with ──────────────   │  │
│  │                                                   │  │
│  │  ┌──────────────────┐  ┌──────────────────────┐   │  │
│  │  │ [G] Google       │  │ [GH] GitHub          │   │  │
│  │  └──────────────────┘  └──────────────────────┘   │  │
│  │                                                   │  │
│  │  Don't have an account? Sign up                   │  │
│  │                                                   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.3 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| LOGIN-01 | メールアドレスとパスワードでログインできる | High |
| LOGIN-02 | Googleアカウントでログインできる | High |
| LOGIN-03 | GitHubアカウントでログインできる | High |
| LOGIN-04 | ログイン成功後、ファイル一覧画面に遷移する | High |
| LOGIN-05 | 「パスワードを忘れた」リンクからリセット画面に遷移できる | High |
| LOGIN-06 | 「アカウント登録」リンクから登録画面に遷移できる | High |

### 2.4 入力フィールド

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|--------------|
| Email | email | Yes | 有効なメール形式 |
| Password | password | Yes | 必須チェックのみ |

### 2.5 エラーメッセージ

| 条件 | メッセージ |
|------|----------|
| メール形式不正 | Please enter a valid email address |
| パスワード未入力 | Password is required |
| 認証失敗 | Invalid email or password |
| メール未確認 | Please verify your email first |
| アカウント停止 | Account suspended |
| サーバーエラー | An unexpected error occurred. Please try again. |

### 2.6 受け入れ基準

- [ ] 正しいメール/パスワードでログインできる
- [ ] ログイン成功後、`/files` に遷移する
- [ ] 認証失敗時にエラーメッセージが表示される
- [ ] ログイン処理中はボタンが無効化される
- [ ] Google OAuthでログインできる
- [ ] GitHub OAuthでログインできる
- [ ] Enterキーでフォーム送信できる

---

## 3. 新規登録画面

### 3.1 ユーザーストーリー

**As a** 新規ユーザー
**I want to** アカウントを作成する
**So that** GC Storageを利用開始できる

### 3.2 画面レイアウト

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│                      GC Storage                         │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │              Create your account                  │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │ Name                                        │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │ Email                                       │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │ Password                                    │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │  ✓ At least 8 characters                         │  │
│  │  ✗ At least one uppercase letter                 │  │
│  │  ✗ At least one number                           │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │ Confirm Password                            │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │            Create account                   │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │                                                   │  │
│  │  ────────────── or continue with ──────────────   │  │
│  │                                                   │  │
│  │  ┌──────────────────┐  ┌──────────────────────┐  │  │
│  │  │ [G] Google       │  │ [GH] GitHub          │  │  │
│  │  └──────────────────┘  └──────────────────────┘  │  │
│  │                                                   │  │
│  │  Already have an account? Log in                  │  │
│  │                                                   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| REG-01 | 名前、メール、パスワードで登録できる | High |
| REG-02 | パスワード強度をリアルタイムで表示する | High |
| REG-03 | 登録成功後、メール確認を促すメッセージを表示する | High |
| REG-04 | OAuth（Google/GitHub）で登録できる | High |
| REG-05 | ログイン画面へのリンクを表示する | High |

### 3.4 入力フィールド

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|--------------|
| Name | text | Yes | 1-100文字 |
| Email | email | Yes | 有効なメール形式 |
| Password | password | Yes | 8文字以上、大文字1つ以上、数字1つ以上 |
| Confirm Password | password | Yes | Passwordと一致 |

### 3.5 パスワード強度チェック

入力中にリアルタイムで以下をチェック表示:

| チェック項目 | 条件 |
|-------------|------|
| 長さ | 8文字以上 |
| 大文字 | 大文字を1つ以上含む |
| 数字 | 数字を1つ以上含む |

### 3.6 エラーメッセージ

| 条件 | メッセージ |
|------|----------|
| 名前未入力 | Name is required |
| 名前が長すぎる | Name must be 100 characters or less |
| メール形式不正 | Please enter a valid email address |
| パスワードが短い | Password must be at least 8 characters |
| 大文字なし | Password must contain at least one uppercase letter |
| 数字なし | Password must contain at least one number |
| パスワード不一致 | Passwords don't match |
| メール重複 | An account with this email already exists |

### 3.7 登録成功画面

```
┌───────────────────────────────────────────────────┐
│                                                   │
│                   ✓ (チェックアイコン)              │
│                                                   │
│              Check your email                     │
│                                                   │
│  We've sent a verification link to               │
│  example@email.com.                              │
│  Please check your inbox and click the link      │
│  to verify your account.                         │
│                                                   │
│         [Back to login]                          │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 3.8 受け入れ基準

- [ ] すべての必須フィールドを入力して登録できる
- [ ] パスワード入力中に強度チェックがリアルタイム更新される
- [ ] バリデーションエラーがフィールドごとに表示される
- [ ] 登録成功後、確認メッセージ画面が表示される
- [ ] 登録処理中はボタンが無効化される
- [ ] OAuthで登録できる

---

## 4. OAuthコールバック画面

### 4.1 ユーザーストーリー

**As a** ユーザー
**I want to** OAuth認証後に自動でログインされる
**So that** 手動でログイン情報を入力せずに済む

### 4.2 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| OAUTH-01 | OAuthプロバイダーからの認可コードを受け取る | High |
| OAUTH-02 | 認可コードをバックエンドに送信して認証を完了する | High |
| OAUTH-03 | 認証成功後、ファイル一覧画面に遷移する | High |
| OAUTH-04 | 認証失敗時にエラーを表示してログイン画面へ戻る | High |

### 4.3 画面表示

#### 処理中

```
┌───────────────────────────────────────────────────┐
│                                                   │
│                   (スピナー)                       │
│                                                   │
│           Completing authentication...            │
│                                                   │
└───────────────────────────────────────────────────┘
```

#### エラー時

```
┌───────────────────────────────────────────────────┐
│                                                   │
│              Authentication failed                │
│                                                   │
│  Authorization was denied. Please try again.     │
│                                                   │
│              [Back to login]                      │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 4.4 エラーメッセージ

| 条件 | メッセージ |
|------|----------|
| ユーザー拒否 | Authorization was denied. Please try again. |
| 認可コードなし | No authorization code received. |
| 無効なプロバイダー | Unsupported OAuth provider. |
| サーバーエラー | Authentication failed. Please try again. |

### 4.5 受け入れ基準

- [ ] Google OAuth認証後、自動でログインされる
- [ ] GitHub OAuth認証後、自動でログインされる
- [ ] 認証成功後、`/files` に遷移する
- [ ] ユーザーがOAuth許可を拒否した場合、エラーが表示される
- [ ] エラー発生時にログイン画面に戻れる

---

## 5. パスワードリセット要求画面

### 5.1 ユーザーストーリー

**As a** パスワードを忘れたユーザー
**I want to** パスワードリセットメールを受け取る
**So that** パスワードを再設定できる

### 5.2 画面レイアウト

```
┌───────────────────────────────────────────────────┐
│                                                   │
│              Forgot your password?                │
│                                                   │
│  Enter your email address and we'll send you     │
│  a link to reset your password.                  │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │ Email                                       │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │           Send reset link                   │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│              ← Back to login                      │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 5.3 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| FORGOT-01 | メールアドレスを入力してリセットリンクを要求できる | High |
| FORGOT-02 | 送信成功後、確認メッセージを表示する | High |
| FORGOT-03 | ログイン画面に戻れる | High |

### 5.4 成功画面

```
┌───────────────────────────────────────────────────┐
│                                                   │
│                   ✓ (チェックアイコン)              │
│                                                   │
│              Check your email                     │
│                                                   │
│  If an account exists for example@email.com,     │
│  we've sent a password reset link.               │
│  Please check your inbox.                        │
│                                                   │
│              ← Back to login                      │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 5.5 受け入れ基準

- [ ] メールアドレスを入力してリセットリンクを要求できる
- [ ] 送信成功後、確認メッセージが表示される
- [ ] 存在しないメールでも成功メッセージを表示する（セキュリティ）
- [ ] ログイン画面に戻れる

---

## 6. パスワードリセット画面

### 6.1 ユーザーストーリー

**As a** リセットメールを受け取ったユーザー
**I want to** 新しいパスワードを設定する
**So that** アカウントに再びアクセスできる

### 6.2 画面レイアウト

```
┌───────────────────────────────────────────────────┐
│                                                   │
│              Reset your password                  │
│                                                   │
│  Enter your new password below.                  │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │ New Password                                │  │
│  └─────────────────────────────────────────────┘  │
│  ✓ At least 8 characters                         │
│  ✓ At least one uppercase letter                 │
│  ✓ At least one number                           │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │ Confirm New Password                        │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │           Reset password                    │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 6.3 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| RESET-01 | URLのトークンを使用してパスワードをリセットする | High |
| RESET-02 | パスワード強度をリアルタイムで表示する | High |
| RESET-03 | リセット成功後、ログイン画面に遷移する | High |
| RESET-04 | 無効なトークンの場合、エラーを表示する | High |

### 6.4 エラーメッセージ

| 条件 | メッセージ |
|------|----------|
| トークンなし | Invalid or missing reset token. Please request a new password reset. |
| トークン期限切れ | Reset token expired. Please request a new password reset. |
| トークン使用済み | Reset token already used. Please request a new password reset. |

### 6.5 成功画面

```
┌───────────────────────────────────────────────────┐
│                                                   │
│                   ✓ (チェックアイコン)              │
│                                                   │
│          Password reset successful                │
│                                                   │
│  Your password has been reset.                   │
│  You can now log in with your new password.      │
│                                                   │
│              [Go to login]                        │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 6.6 受け入れ基準

- [ ] 有効なトークンで新しいパスワードを設定できる
- [ ] パスワード強度チェックがリアルタイム表示される
- [ ] リセット成功後、成功メッセージが表示される
- [ ] 無効なトークンでエラーメッセージが表示される
- [ ] 成功画面からログイン画面に遷移できる

---

## 7. メール確認画面

### 7.1 ユーザーストーリー

**As a** 新規登録したユーザー
**I want to** メール確認リンクをクリックしてアカウントを有効化する
**So that** ログインできるようになる

### 7.2 機能要件

| ID | 要件 | 優先度 |
|----|------|--------|
| VERIFY-01 | URLのトークンを使用してメールを確認する | High |
| VERIFY-02 | 確認成功後、ログイン画面に遷移する | High |
| VERIFY-03 | 無効なトークンの場合、エラーを表示する | High |

### 7.3 画面表示

#### 処理中

```
┌───────────────────────────────────────────────────┐
│                                                   │
│                   (スピナー)                       │
│                                                   │
│            Verifying your email...                │
│                                                   │
└───────────────────────────────────────────────────┘
```

#### 成功

```
┌───────────────────────────────────────────────────┐
│                                                   │
│                   ✓ (チェックアイコン)              │
│                                                   │
│              Email verified!                      │
│                                                   │
│  Your account has been verified.                 │
│  You can now log in.                             │
│                                                   │
│              [Go to login]                        │
│                                                   │
└───────────────────────────────────────────────────┘
```

#### エラー

```
┌───────────────────────────────────────────────────┐
│                                                   │
│              Verification failed                  │
│                                                   │
│  Invalid or expired verification token.          │
│                                                   │
│              [Resend verification email]          │
│              [Go to login]                        │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 7.4 受け入れ基準

- [ ] 有効なトークンでメールが確認される
- [ ] 確認成功後、成功メッセージが表示される
- [ ] 無効なトークンでエラーメッセージが表示される
- [ ] ログイン画面に遷移できる

---

## 8. 共通要件

### 8.1 フォーム操作

| ID | 要件 | 優先度 |
|----|------|--------|
| FORM-01 | Enterキーでフォーム送信できる | High |
| FORM-02 | フィールド間をTabキーで移動できる | High |
| FORM-03 | 送信中はすべての入力を無効化する | High |
| FORM-04 | エラー発生時に該当フィールドにフォーカスする | Medium |

### 8.2 セキュリティ

| ID | 要件 | 優先度 |
|----|------|--------|
| SEC-01 | パスワードフィールドは入力をマスクする | High |
| SEC-02 | ログイン失敗時に「メールが存在しない」等の詳細を明かさない | High |
| SEC-03 | OAuthでstate パラメータを使用してCSRFを防止する | High |

### 8.3 アクセシビリティ

| ID | 要件 | 優先度 |
|----|------|--------|
| A11Y-01 | すべてのフォームフィールドにラベルを付ける | High |
| A11Y-02 | エラーメッセージをスクリーンリーダーに通知する | Medium |
| A11Y-03 | フォーカス状態を視覚的に示す | High |

---

## 関連ドキュメント

- [fe-foundation.md](./fe-foundation.md) - フロントエンド基盤
- [auth-identity.md](./auth-identity.md) - 認証バックエンド仕様
- [FRONTEND.md](../02-architecture/FRONTEND.md) - フロントエンド設計
